name: TechVault CI/CD

on:
  push:
    branches:
      - "4-ci-cd"
  pull_request:
    branches:
      - "4-ci-cd"

jobs:
  build-test-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 40
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Temurin JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Start infrastructure services for tests
        run: |
          docker compose up -d postgres-db rabbitmq
          echo "Waiting for Postgres to accept connections..."
          for i in {1..20}; do
            if docker exec postgres-db pg_isready -U postgres > /dev/null 2>&1; then
              echo "Postgres is ready"
              break
            fi
            sleep 3
          done
          docker exec postgres-db pg_isready -U postgres

      - name: Build & test Spring Boot services
        run: |
          set -e
          for dir in eureka-server auth-service user-service content-service progress-service grading-service cdn-service; do
            echo "::group::Building $dir"
            (cd "$dir" && mvn -B clean verify)
            echo "::endgroup::"
          done

      - name: Build frontend
        run: |
          cd frontend
          npm ci
          npm run build

      - name: Docker Compose build
        run: |
          docker compose build

      - name: Smoke deploy stack
        run: |
          docker compose up -d eureka-server rabbitmq postgres-db piston-service
          echo "Waiting for core infrastructure services to settle..."
          sleep 20
          docker compose up -d auth-service user-service content-service progress-service grading-service cdn-service api-gateway
          echo "Waiting for application services to settle..."
          sleep 60
          docker compose ps
          EXITED=$(docker compose ps --status=exited --services | grep -vE '^(piston-runtime-installer)$' || true)
          if [ -n "$EXITED" ]; then
            echo "These services exited unexpectedly: $EXITED"
            exit 1
          fi

      - name: Tear down stack
        if: always()
        run: docker compose down -v
